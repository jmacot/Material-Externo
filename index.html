<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Solicitud de Material Externo</title>
  <link rel="apple-touch-icon" sizes="180x180" href="icon-180.png">
  <link rel="apple-touch-icon" sizes="167x167" href="icon-167.png">
  <link rel="apple-touch-icon" sizes="152x152" href="icon-152.png">
  <link rel="apple-touch-icon" sizes="120x120" href="icon-120.png">
  <link rel="apple-touch-icon" href="icon.png">
  <link rel="icon" type="image/png" href="icon.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-title" content="Material Externo">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: Arial, sans-serif; background: #f0f2f5; min-height: 100vh; padding: 30px 20px; }
    .app-container { max-width: 860px; margin: 0 auto; }
    h1.app-title { text-align: center; color: #1a3a5c; font-size: 22px; margin-bottom: 24px; }

    .form-card { background: white; border-radius: 10px; box-shadow: 0 2px 12px rgba(0,0,0,0.1); padding: 32px; margin-bottom: 28px; }
    .section-title { font-size: 13px; font-weight: 700; color: #1a3a5c; text-transform: uppercase; letter-spacing: 1px; border-bottom: 2px solid #1a3a5c; padding-bottom: 6px; margin-bottom: 18px; margin-top: 24px; }
    .section-title:first-child { margin-top: 0; }
    .form-row { display: flex; gap: 16px; margin-bottom: 14px; flex-wrap: wrap; }
    .form-group { display: flex; flex-direction: column; flex: 1; min-width: 140px; }
    .form-group.full { flex: 0 0 100%; }
    .form-group.w-third { flex: 0 0 calc(33% - 11px); }
    .form-group.w-quarter { flex: 0 0 calc(25% - 12px); }
    label { font-size: 11px; font-weight: 700; color: #555; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 5px; }
    input[type="text"], input[type="date"], input[type="number"], textarea, select {
      border: 1.5px solid #d1d5db; border-radius: 6px; padding: 9px 12px;
      font-size: 14px; font-family: Arial, sans-serif; color: #222;
      transition: border-color 0.2s; background: white; width: 100%;
    }
    input:focus, textarea:focus, select:focus { outline: none; border-color: #1a3a5c; box-shadow: 0 0 0 3px rgba(26,58,92,0.08); }
    textarea { resize: vertical; min-height: 60px; }
    select { cursor: pointer; appearance: auto; }

    .sexo-group { display: flex; gap: 10px; }
    .sexo-btn { flex: 1; padding: 9px; border: 1.5px solid #d1d5db; border-radius: 6px; background: white; cursor: pointer; font-size: 14px; font-weight: 600; color: #555; transition: all 0.2s; }
    .sexo-btn:hover { border-color: #1a3a5c; color: #1a3a5c; }
    .sexo-btn.active { background: #1a3a5c; color: white; border-color: #1a3a5c; }

    .material-bloque { background: #f8f9fb; border: 1px solid #e5e7eb; border-radius: 10px; padding: 16px; margin-bottom: 12px; }
    .logos-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-bottom: 14px; }
    @media (max-width: 480px) { .logos-grid { grid-template-columns: repeat(2, 1fr); gap: 10px; } }
    .logo-btn { border: 2px solid #e5e7eb; border-radius: 8px; background: white; padding: 10px 8px; cursor: pointer; transition: all 0.18s; display: flex; align-items: center; justify-content: center; min-height: 64px; width: 100%; }
    @media (max-width: 480px) { .logo-btn { min-height: 72px; padding: 12px 8px; } }
    .logo-btn:hover { border-color: #1a3a5c; box-shadow: 0 2px 8px rgba(26,58,92,0.15); transform: translateY(-1px); }
    .logo-btn.active { border-color: #1a3a5c; background: #eef2f7; box-shadow: 0 0 0 3px rgba(26,58,92,0.12); }
    .logo-btn img { max-height: 36px; max-width: 90%; object-fit: contain; display: block; margin: 0 auto; }
    @media (max-width: 480px) { .logo-btn img { max-height: 48px; } }

    .mat-campos { display: flex; gap: 10px; align-items: flex-end; flex-wrap: wrap; }
    .mat-campos .form-group { margin: 0; flex: 1 1 140px; min-width: 0; }
    .mat-campos .form-group:first-child { flex: 1 1 160px; }
    .mat-campos .form-group:last-child { flex: 2 1 200px; }

    .mat-sugerencias { margin-top: 8px; display: flex; flex-wrap: wrap; gap: 6px; }
    .mat-chip { background: white; border: 1.5px solid #c3d0e0; color: #1a3a5c; border-radius: 20px; padding: 4px 13px; font-size: 12px; font-weight: 600; cursor: pointer; transition: all 0.15s; }
    .mat-chip:hover, .mat-chip.selected { background: #1a3a5c; color: white; border-color: #1a3a5c; }

    .btn-remove { background: none; border: none; cursor: pointer; color: #dc2626; font-size: 22px; padding: 2px 8px; border-radius: 4px; opacity: 0.65; transition: opacity 0.2s; line-height: 1; }
    .btn-remove:hover { opacity: 1; }
    .btn-add { display: inline-flex; align-items: center; gap: 6px; background: none; border: 1.5px dashed #1a3a5c; color: #1a3a5c; border-radius: 6px; padding: 8px 16px; font-size: 13px; font-weight: 600; cursor: pointer; margin-top: 4px; transition: background 0.2s; }
    .btn-add:hover { background: #eef2f7; }

    .firma-row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-top: 14px; }

    .actions { display: flex; gap: 14px; justify-content: center; flex-wrap: wrap; }
    .btn-primary { background: #1a3a5c; color: white; border: none; border-radius: 8px; padding: 13px 32px; font-size: 15px; font-weight: 700; cursor: pointer; transition: background 0.2s; }
    .btn-primary:hover { background: #14304f; }
    .btn-secondary { background: white; color: #666; border: 1.5px solid #d1d5db; border-radius: 8px; padding: 13px 24px; font-size: 15px; font-weight: 600; cursor: pointer; transition: all 0.2s; }
    .btn-secondary:hover { border-color: #999; color: #333; }

    #preview-section { display: none; }
    .preview-card { background: white; border-radius: 10px; box-shadow: 0 2px 12px rgba(0,0,0,0.1); padding: 32px; margin-bottom: 20px; }
    .informe { font-family: Arial, sans-serif; font-size: 13px; color: #222; max-width: 700px; margin: 0 auto; }
    .inf-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; border-bottom: 3px solid #1a3a5c; padding-bottom: 16px; }
    .inf-header img { max-height: 64px; }
    .inf-titulo { font-size: 20px; font-weight: 700; color: #1a3a5c; text-align: right; letter-spacing: 2px; text-transform: uppercase; }
    .inf-tabla { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
    .inf-tabla tr:first-child td { background: #1a3a5c; color: white; padding: 8px 12px; font-size: 14px; font-weight: 600; }
    .inf-tabla tr:first-child td strong { color: #a8c4e0; font-size: 10px; display: block; text-transform: uppercase; letter-spacing: 0.5px; font-weight: 400; }
    .inf-tabla tr:not(:first-child) td { padding: 7px 12px; border: 1px solid #dde3ea; font-size: 13px; background: #f8fafc; }
    .inf-tabla tr:not(:first-child) td strong { color: #1a3a5c; font-size: 10px; display: block; text-transform: uppercase; letter-spacing: 0.5px; }
    .inf-body { margin-bottom: 24px; line-height: 1.8; font-size: 13px; padding: 14px 16px; background: #f8fafc; border-left: 4px solid #1a3a5c; border-radius: 0 6px 6px 0; }
    .inf-mat-section { margin-top: 14px; }
    .inf-prov { font-weight: 700; color: #1a3a5c; margin-top: 10px; margin-bottom: 4px; font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px; border-bottom: 1px solid #dde3ea; padding-bottom: 3px; }
    .inf-mat { padding: 3px 0 3px 16px; font-size: 13px; }
    .inf-mat::before { content: "‚ñ∏ "; color: #1a3a5c; }
    .inf-firma { margin-top: 36px; text-align: right; border-top: 1px solid #dde3ea; padding-top: 16px; color: #444; }
    .inf-firma strong { font-size: 14px; color: #1a3a5c; display: block; margin-bottom: 4px; }
    .inf-firma .firma-esp { font-size: 12px; color: #666; font-style: italic; display: block; margin-bottom: 6px; }
    .inf-firma .firma-cnp { font-size: 11px; color: #888; display: block; margin-bottom: 8px; letter-spacing: 0.3px; }
    .inf-firma .firma-fecha { font-size: 12px; color: #444; display: block; padding-top: 8px; border-top: 1px dashed #e5e7eb; margin-top: 4px; }

    .preview-actions { display: flex; gap: 14px; justify-content: center; flex-wrap: wrap; }
    .btn-green { background: #16a34a; color: white; border: none; border-radius: 8px; padding: 13px 32px; font-size: 15px; font-weight: 700; cursor: pointer; transition: background 0.2s; }
    .btn-green:hover { background: #15803d; }
    .btn-blue { background: #0ea5e9; color: white; border: none; border-radius: 8px; padding: 13px 28px; font-size: 15px; font-weight: 700; cursor: pointer; transition: background 0.2s; }
    .btn-blue:hover { background: #0284c7; }

    @media print {
      body { background: white; padding: 0; }
      .form-card, .actions, .preview-actions, h1.app-title { display: none !important; }
      #preview-section { display: block !important; }
      .preview-card { box-shadow: none; padding: 0; }
    }
  </style>
</head>
<body>
<div class="app-container">
  <h1 class="app-title">üìã Solicitud de Material Externo</h1>

  <div class="form-card" id="form-section">

    <div class="section-title">Datos del Paciente</div>
    <div class="form-row">
      <div class="form-group full">
        <label>Nombre completo</label>
        <input type="text" id="nombre" placeholder="Ej: Garc√≠a L√≥pez, Mar√≠a" />
      </div>
    </div>
    <div class="form-row">
      <div class="form-group w-third">
        <label>Fecha de nacimiento</label>
        <input type="text" id="fecha_nac" inputmode="numeric" placeholder="DD/MM/AAAA" maxlength="10" autocomplete="off" style="letter-spacing:1px;" oninput="autoFecha(this)" />
      </div>
      <div class="form-group w-quarter">
        <label>Edad</label>
        <input type="number" id="edad" min="0" max="120" placeholder="" style="background:#f8f9fb;" readonly />
      </div>
      <div class="form-group w-quarter">
        <label>NHC</label>
        <input type="text" id="nhc" placeholder="" />
      </div>
    </div>
    <div class="form-row">
      <div class="form-group" style="max-width:240px">
        <label>Sexo</label>
        <div class="sexo-group">
          <button class="sexo-btn" id="btn-hombre" onclick="setSexo('Hombre')">‚ôÇ Hombre</button>
          <button class="sexo-btn" id="btn-mujer" onclick="setSexo('Mujer')">‚ôÄ Mujer</button>
        </div>
      </div>
    </div>

    <div class="section-title">Datos Cl√≠nicos</div>
    <div class="form-row">
      <div class="form-group full">
        <label>Patolog√≠a / Diagn√≥stico</label>
        <textarea id="patologia" rows="2" placeholder="Ej: Gonartrosis medial por genu varo"></textarea>
      </div>
    </div>
    <div class="form-row">
      <div class="form-group full">
        <label>Intervenci√≥n quir√∫rgica</label>
        <input type="text" id="intervencion" placeholder="Ej: Osteotom√≠a tibial valguizante" />
      </div>
    </div>

    <div class="section-title">Material Solicitado</div>
    <div id="materiales-container"></div>
    <button class="btn-add" onclick="addMaterial()">Ôºã A√±adir material</button>

    <div class="section-title">Fecha y Firma</div>
    <div class="form-row">
      <div class="form-group w-third">
        <label>Fecha de solicitud</label>
        <input type="date" id="fecha_solicitud" />
      </div>
    </div>
    <div class="firma-row">
      <div class="form-group">
        <label>M√©dico solicitante</label>
        <select id="firma_medico">
        <option value="">‚Äî Seleccionar m√©dico ‚Äî</option>
        <option value="Dr. Baquero">Dr. Baquero</option>
        <option value="Dra. Barcia">Dra. Barcia</option>
        <option value="Dr. Barrionuevo">Dr. Barrionuevo</option>
        <option value="Dr. Centeno">Dr. Centeno</option>
        <option value="Dr. Cintado">Dr. Cintado</option>
        <option value="Dr. Contreras">Dr. Contreras</option>
        <option value="Dra. C√°ceres">Dra. C√°ceres</option>
        <option value="Dra. Delgado">Dra. Delgado</option>
        <option value="Dr. D√≠ez">Dr. D√≠ez</option>
        <option value="Dra. Estrada">Dra. Estrada</option>
        <option value="Dra. Exp√≥sito">Dra. Exp√≥sito</option>
        <option value="Dra. Gonz√°lez">Dra. Gonz√°lez</option>
        <option value="Dra. Grijalvo">Dra. Grijalvo</option>
        <option value="Dra. Hern√°ndez">Dra. Hern√°ndez</option>
        <option value="Dr. Hijazi">Dr. Hijazi</option>
        <option value="Dr. Li√±√°n">Dr. Li√±√°n</option>
        <option value="Dr. Mart√≠n">Dr. Mart√≠n</option>
        <option value="Dr. Monge">Dr. Monge</option>
        <option value="Dr. Ortiz">Dr. Ortiz</option>
        <option value="Dr. Pereira">Dr. Pereira</option>
        <option value="Dr. P√©rez">Dr. P√©rez</option>
        <option value="Dra. Rial">Dra. Rial</option>
        <option value="Dr. Soler">Dr. Soler</option>
        <option value="Dra. S√°nchez">Dra. S√°nchez</option>
        <option value="Dr. Villa">Dr. Villa</option>
        </select>
      </div>
      <div class="form-group">
        <label>CNP / N¬∫ Colegiado</label>
        <input type="text" id="firma_cnp" placeholder="Ej: 41/1234567" />
      </div>
    </div>

  </div>

  <div class="actions">
    <button class="btn-primary" onclick="generarInforme()">üëÅ Ver informe</button>
    <button class="btn-secondary" onclick="resetForm()">‚Ü∫ Limpiar</button>
  </div>

  <div id="preview-section">
    <div class="preview-card">
      <div class="informe" id="informe-preview"></div>
    </div>
    <div class="preview-actions">
      <button class="btn-green" onclick="generarPDF()">‚¨á Descargar PDF</button>
      <button class="btn-secondary" onclick="volverFormulario()">‚úè Editar</button>
    </div>
  </div>

</div>
<script src="materiales.js"></script>
<script>
const LOGO_INFORME = "logo_informe.png";
const PROVEEDORES = {
  "arthrex":     { "nombre": "ARTHREX",                  "logo": "logos/arthrex.png" },
  "mba":         { "nombre": "MBA SURGICAL EMPOWERMENT", "logo": "logos/mba.png" },
  "newclip":     { "nombre": "NEWCLIP",                  "logo": "logos/newclip.png" },
  "palex":       { "nombre": "PALEX",                    "logo": "logos/palex.png" },
  "smithnephew": { "nombre": "SMITH & NEPHEW",           "logo": "logos/smithnephew.png" },
  "stryker":     { "nombre": "STRYKER",                  "logo": "logos/stryker.png" },
  "synthes":     { "nombre": "SYNTHES",                  "logo": "logos/synthes.png" },
  "zimmer":      { "nombre": "ZIMMER BIOMET",            "logo": "logos/zimmer.png" }
};

let sexoSeleccionado = '';
let matCount = 0;

window.addEventListener('DOMContentLoaded', () => {
  const hoy = new Date().toISOString().split('T')[0];
  document.getElementById('fecha_solicitud').value = hoy;
  addMaterial();
  // Restaurar √∫ltimo m√©dico y CNP
  const lastMedico = localStorage.getItem('ultimo_medico');
  const lastCnp    = localStorage.getItem('ultimo_cnp');
  if (lastMedico) document.getElementById('firma_medico').value = lastMedico;
  if (lastCnp)    document.getElementById('firma_cnp').value    = lastCnp;
});

function setSexo(s) {
  sexoSeleccionado = s;
  document.getElementById('btn-hombre').classList.toggle('active', s === 'Hombre');
  document.getElementById('btn-mujer').classList.toggle('active', s === 'Mujer');
}

function addMaterial() {
  const id = matCount++;
  const container = document.getElementById('materiales-container');

  const bloque = document.createElement('div');
  bloque.className = 'material-bloque';
  bloque.id = 'bloque-' + id;

  const header = document.createElement('div');
  header.style.cssText = 'display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;';

  const headerLeft = document.createElement('span');
  headerLeft.style.cssText = 'font-size:12px;font-weight:700;color:#1a3a5c;text-transform:uppercase;letter-spacing:.5px;';
  headerLeft.textContent = 'Material ' + (id + 1);
  header.appendChild(headerLeft);

  const headerRight = document.createElement('div');
  headerRight.style.cssText = 'display:flex;gap:8px;align-items:center;';

  // Bot√≥n limpiar (siempre visible, discreto)
  const btnLimpiar = document.createElement('button');
  btnLimpiar.type = 'button';
  btnLimpiar.title = 'Limpiar campos';
  btnLimpiar.style.cssText = 'background:none;border:none;cursor:pointer;color:#999;font-size:12px;padding:2px 6px;border-radius:4px;transition:color 0.2s;';
  btnLimpiar.innerHTML = '&#x21BA; limpiar';
  btnLimpiar.onmouseenter = () => btnLimpiar.style.color = '#1a3a5c';
  btnLimpiar.onmouseleave = () => btnLimpiar.style.color = '#999';
  btnLimpiar.onclick = () => {
    // Limpiar logo seleccionado
    bloque.querySelectorAll('.logo-btn').forEach(b => b.classList.remove('active'));
    // Limpiar campos
    const pInput = document.getElementById('prov-' + id);
    const mInput = document.getElementById('mat-' + id);
    const dInput = document.getElementById('matd-' + id);
    if (pInput) pInput.value = '';
    if (mInput) mInput.value = '';
    if (dInput) dInput.value = '';
    // Limpiar sugerencias seleccionadas
    const sugs = document.getElementById('sugs-' + id);
    if (sugs) { sugs.querySelectorAll('.mat-chip').forEach(c => c.classList.remove('selected')); }
  };
  headerRight.appendChild(btnLimpiar);

  if (id > 0) {
    const btnX = document.createElement('button');
    btnX.type = 'button';
    btnX.className = 'btn-remove';
    btnX.innerHTML = '√ó';
    btnX.title = 'Eliminar bloque';
    btnX.onclick = () => bloque.remove();
    headerRight.appendChild(btnX);
  }
  header.appendChild(headerRight);
  bloque.appendChild(header);

  const grid = document.createElement('div');
  grid.className = 'logos-grid';
  Object.entries(PROVEEDORES).forEach(([key, data]) => {
    const btn = document.createElement('button');
    btn.type = 'button';
    btn.className = 'logo-btn';
    btn.title = data.nombre;
    const img = document.createElement('img');
    img.src = data.logo;
    img.alt = data.nombre;
    btn.appendChild(img);
    btn.addEventListener('click', () => selectProveedor(btn, grid, data.nombre, id));
    grid.appendChild(btn);
  });
  bloque.appendChild(grid);

  const campos = document.createElement('div');
  campos.className = 'mat-campos';
  campos.innerHTML =
    '<div class="form-group">' +
      '<label>Casa Comercial</label>' +
      '<input type="text" id="prov-' + id + '" placeholder="Selecciona logo o escribe" />' +
    '</div>' +
    '<div class="form-group">' +
      '<label>Material</label>' +
      '<input type="text" id="mat-' + id + '" placeholder="Selecciona de la lista o escribe" />' +
      '<input type="hidden" id="matd-' + id + '" />' +
    '</div>';
  bloque.appendChild(campos);

  const sugs = document.createElement('div');
  sugs.className = 'mat-sugerencias';
  sugs.id = 'sugs-' + id;
  bloque.appendChild(sugs);

  container.appendChild(bloque);
}

function selectProveedor(btn, grid, nombre, id) {
  grid.querySelectorAll('.logo-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  document.getElementById('prov-' + id).value = nombre;

  const sugs = document.getElementById('sugs-' + id);
  sugs.innerHTML = '';
  const matInput = document.getElementById('mat-' + id);
  const matDesc  = document.getElementById('matd-' + id);
  (CATALOGO[nombre] || []).forEach(m => {
    const chip = document.createElement('span');
    chip.className = 'mat-chip';
    chip.textContent = typeof m === 'object' ? m.n : m;
    chip.addEventListener('click', () => {
      const nombre_mat = typeof m === 'object' ? m.n : m;
      const desc_mat   = typeof m === 'object' ? m.d : m;
      matInput.value = nombre_mat;
      if (matDesc) matDesc.value = desc_mat;
      sugs.querySelectorAll('.mat-chip').forEach(c => c.classList.remove('selected'));
      chip.classList.add('selected');
    });
    sugs.appendChild(chip);
  });
}

function formatDate(v) {
  if (!v) return '';
  const [y, m, d] = v.split('-');
  return d + '/' + m + '/' + y;
}
function getMes(v) {
  if (!v) return '';
  const meses = ['ENERO','FEBRERO','MARZO','ABRIL','MAYO','JUNIO','JULIO','AGOSTO','SEPTIEMBRE','OCTUBRE','NOVIEMBRE','DICIEMBRE'];
  return meses[parseInt(v.split('-')[1]) - 1];
}

function generarInforme() {
  const nombre       = document.getElementById('nombre').value.trim().toUpperCase();
  const edad         = document.getElementById('edad').value.trim();
  const fechaNac     = getFechaNac ? getFechaNac() : '‚Äî';
  const nhc          = document.getElementById('nhc').value.trim();
  const patologia    = document.getElementById('patologia').value.trim().toUpperCase();
  const intervencion = document.getElementById('intervencion').value.trim();
  const fechaSol     = document.getElementById('fecha_solicitud').value;
  const firmaMedico  = document.getElementById('firma_medico').value;
  const firmaCnp     = document.getElementById('firma_cnp').value.trim();

  if (!nombre) { alert('Introduce el nombre del paciente.'); return; }
  // Guardar m√©dico y CNP para la pr√≥xima vez
  if (firmaMedico) localStorage.setItem('ultimo_medico', firmaMedico);
  if (firmaCnp)    localStorage.setItem('ultimo_cnp', firmaCnp);

  const bloques = document.querySelectorAll('.material-bloque');
  const mats = [];
  bloques.forEach(bl => {
    const idNum = bl.id.replace('bloque-', '');
    const prov    = document.getElementById('prov-'  + idNum).value.trim().toUpperCase();
    const mat     = document.getElementById('mat-'   + idNum).value.trim();
    const matdEl  = document.getElementById('matd-'  + idNum);
    const matDesc = matdEl && matdEl.value.trim() ? matdEl.value.trim() : mat.toUpperCase();
    if (prov || mat) mats.push({ prov, mat: matDesc });
  });

  const porProv = {};
  mats.forEach(m => {
    if (!porProv[m.prov]) porProv[m.prov] = [];
    porProv[m.prov].push(m.mat);
  });
  let matsHTML = '';
  Object.entries(porProv).forEach(([p, items]) => {
    matsHTML += '<div class="inf-prov">' + p + ':</div>';
    items.forEach(i => matsHTML += '<div class="inf-mat">' + i + '</div>');
  });

  let cuerpo = '';
  if (edad && patologia && intervencion) {
    cuerpo = 'Paciente de ' + edad + ' a&ntilde;os con <strong>' + patologia + '</strong>, solicito material para intervenci&oacute;n quir&uacute;rgica (' + intervencion + ') el ' + formatDate(fechaSol);
  } else if (patologia) {
    cuerpo = 'Diagn&oacute;stico: <strong>' + patologia + '</strong>';
  }

  let fechaFirma = '';
  if (fechaSol) {
    const d = parseInt(fechaSol.split('-')[2]);
    fechaFirma = 'En Bormujos, a ' + d + ' de ' + getMes(fechaSol) + ' de ' + fechaSol.split('-')[0];
  }

  document.getElementById('informe-preview').innerHTML =
    '<div class="inf-header">' +
      '<img src="' + LOGO_INFORME + '" alt="Logo" />' +
      '<div class="inf-titulo">Informe M&eacute;dico</div>' +
    '</div>' +
    '<table class="inf-tabla">' +
      '<tr><td colspan="3"><strong>Paciente</strong>' + nombre + '</td></tr>' +
      '<tr>' +
        '<td><strong>Edad</strong>' + (edad || '‚Äî') + ' a&ntilde;os</td>' +
        '<td><strong>Fecha de nacimiento</strong>' + (fechaNac || '‚Äî') + '</td>' +
        '<td><strong>Sexo</strong>' + (sexoSeleccionado || '‚Äî') + '</td>' +
      '</tr>' +
      '<tr><td colspan="3"><strong>N&ordm; Historia Cl&iacute;nica</strong>' + (nhc || '‚Äî') + '</td></tr>' +
    '</table>' +
    '<div class="inf-body">' +
      '<p>' + cuerpo + '</p>' +
      (mats.length ? '<div class="inf-mat-section">' + matsHTML + '</div>' : '') +
    '</div>' +
    '<div class="inf-firma">' +
      '<strong>' + (firmaMedico || '‚Äî') + '</strong>' +
      '<span class="firma-esp">Cirug√≠a Ortop√©dica y Traumatolog√≠a</span>' +
      (firmaCnp ? '<span class="firma-cnp">CNP ' + firmaCnp + '</span>' : '') +
      '<span class="firma-fecha">' + fechaFirma + '</span>' +
    '</div>';

  document.getElementById('preview-section').style.display = 'block';
  document.getElementById('preview-section').scrollIntoView({ behavior: 'smooth' });
}

function volverFormulario() {
  document.getElementById('preview-section').style.display = 'none';
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

function resetForm() {
  if (!confirm('¬øLimpiar todos los datos?')) return;
  document.querySelectorAll('input[type="text"], input[type="number"], textarea').forEach(el => el.value = '');
  document.querySelectorAll('input[type="date"]').forEach(el => el.value = '');
  document.getElementById('fecha_solicitud').value = new Date().toISOString().split('T')[0];
  document.getElementById('firma_medico').value = '';
  const fnEl = document.getElementById('fecha_nac'); if(fnEl) fnEl.value = ''; document.getElementById('edad').value = '';
  sexoSeleccionado = '';
  document.getElementById('btn-hombre').classList.remove('active');
  document.getElementById('btn-mujer').classList.remove('active');
  document.getElementById('materiales-container').innerHTML = '';
  matCount = 0;
  addMaterial();
  document.getElementById('preview-section').style.display = 'none';
}



function autoFecha(input) {
  let raw = input.value.replace(/\D/g, '');
  if (raw.length > 8) raw = raw.slice(0, 8);
  let formatted = '';
  if (raw.length <= 2) {
    formatted = raw;
  } else if (raw.length <= 4) {
    formatted = raw.slice(0,2) + '/' + raw.slice(2);
  } else {
    formatted = raw.slice(0,2) + '/' + raw.slice(2,4) + '/' + raw.slice(4);
  }
  input.value = formatted;
  // Calcular edad al completar la fecha
  if (raw.length === 8) {
    const d = parseInt(raw.slice(0,2));
    const m = parseInt(raw.slice(2,4)) - 1;
    const y = parseInt(raw.slice(4,8));
    const hoy = new Date();
    let edad = hoy.getFullYear() - y;
    if (hoy.getMonth() < m || (hoy.getMonth() === m && hoy.getDate() < d)) edad--;
    if (edad >= 0 && edad <= 120) {
      document.getElementById('edad').value = edad;
    } else {
      document.getElementById('edad').value = '';
    }
  } else {
    document.getElementById('edad').value = '';
  }
}

function getFechaNac() {
  const v = document.getElementById('fecha_nac').value.trim();
  return v || '‚Äî';
}

async function generarPDF() {
  const preview = document.getElementById('informe-preview');
  if (!preview || preview.innerHTML.trim() === '') {
    alert('Primero pulsa "Ver informe" para generar la vista previa.');
    return;
  }

  // Crear contenedor temporal a tama√±o fijo de escritorio (794px = A4 a 96dpi)
  const wrapper = document.createElement('div');
  wrapper.style.cssText = [
    'position:fixed',
    'left:-9999px',
    'top:0',
    'width:794px',
    'background:#ffffff',
    'padding:40px 48px',
    'font-family:Arial,sans-serif',
    'font-size:13px',
    'color:#222',
    'box-sizing:border-box',
    'z-index:-1'
  ].join(';');
  wrapper.innerHTML = preview.innerHTML;
  document.body.appendChild(wrapper);

  // Forzar estilos del informe en el wrapper (heredados del .informe)
  const styleClone = document.createElement('style');
  styleClone.textContent = `
    .inf-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:24px; border-bottom:3px solid #1a3a5c; padding-bottom:16px; }
    .inf-header img { max-height:64px; }
    .inf-titulo { font-size:20px; font-weight:700; color:#1a3a5c; text-align:right; letter-spacing:2px; text-transform:uppercase; }
    .inf-tabla { width:100%; border-collapse:collapse; margin-bottom:20px; }
    .inf-tabla tr:first-child td { background:#1a3a5c; color:white; padding:8px 12px; font-size:14px; font-weight:600; }
    .inf-tabla tr:first-child td strong { color:#a8c4e0; font-size:10px; display:block; text-transform:uppercase; letter-spacing:0.5px; font-weight:400; }
    .inf-tabla tr:not(:first-child) td { padding:7px 12px; border:1px solid #dde3ea; font-size:13px; background:#f8fafc; }
    .inf-tabla tr:not(:first-child) td strong { color:#1a3a5c; font-size:10px; display:block; text-transform:uppercase; letter-spacing:0.5px; }
    .inf-body { margin-bottom:24px; line-height:1.8; font-size:13px; padding:14px 16px; background:#f8fafc; border-left:4px solid #1a3a5c; border-radius:0 6px 6px 0; }
    .inf-mat-section { margin-top:14px; }
    .inf-prov { font-weight:700; color:#1a3a5c; margin-top:10px; margin-bottom:4px; font-size:13px; text-transform:uppercase; letter-spacing:0.5px; border-bottom:1px solid #dde3ea; padding-bottom:3px; }
    .inf-mat { padding:3px 0 3px 16px; font-size:13px; }
    .inf-mat::before { content:"‚ñ∏ "; color:#1a3a5c; }
    .inf-firma { margin-top:36px; text-align:right; border-top:1px solid #dde3ea; padding-top:16px; color:#444; }
    .inf-firma strong { font-size:14px; color:#1a3a5c; display:block; margin-bottom:4px; }
    .inf-firma .firma-esp { font-size:12px; color:#666; font-style:italic; display:block; margin-bottom:6px; }
    .inf-firma .firma-cnp { font-size:11px; color:#888; display:block; margin-bottom:8px; letter-spacing:0.3px; }
    .inf-firma .firma-fecha { font-size:12px; color:#444; display:block; padding-top:8px; border-top:1px dashed #e5e7eb; margin-top:4px; }
  `;
  wrapper.appendChild(styleClone);

  const { jsPDF } = window.jspdf;
  const canvas = await html2canvas(wrapper, {
    scale: 2,
    useCORS: true,
    backgroundColor: '#ffffff',
    width: 794,
    windowWidth: 794
  });
  document.body.removeChild(wrapper);

  const imgData = canvas.toDataURL('image/png');
  const pdf = new jsPDF({ orientation: 'portrait', unit: 'mm', format: 'a4' });
  const pdfW = pdf.internal.pageSize.getWidth();
  const pdfH = pdf.internal.pageSize.getHeight();
  const imgW = pdfW - 20;
  const imgH = (canvas.height * imgW) / canvas.width;
  pdf.addImage(imgData, 'PNG', 10, 10, imgW, Math.min(imgH, pdfH - 20));
  const nombre = document.getElementById('nombre').value.trim() || 'informe';
  pdf.save('solicitud_material_' + nombre.replace(/\s+/g,'_').toLowerCase() + '.pdf');
}

</script>
</body>
</html>